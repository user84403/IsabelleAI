<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://mzccaacasiuvixvhscrt.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16Y2NhYWNhc2l1dml4dmhzY3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQyNzEsImV4cCI6MjA4NTk5MDI3MX0.CteAnSaurF9ZTHORrJEsCLntaaD2XLj_sycQM4BvLrA";

  const CHAT_ENDPOINT = SUPABASE_URL + "/functions/v1/chat";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const statusText = document.getElementById("statusText");

  const loginView = document.getElementById("loginView");
  const chatView = document.getElementById("chatView");

  const logoutPill = document.getElementById("logoutPill");
  const clearPill = document.getElementById("clearPill");

  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const loginErr = document.getElementById("loginErr");
  const loginOk = document.getElementById("loginOk");

  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const clearChatEl = document.getElementById("clearChat");
  const exportChatEl = document.getElementById("exportChat");
  const logoutBtn = document.getElementById("logoutBtn");

  const themeToggle = document.getElementById("themeToggle");
  const themeLabel = document.getElementById("themeLabel");
  const THEME_KEY = "isabelle_ai_theme";

  const STORAGE_KEY = "isabelle_ai_chat_auth_v1";
  let history = loadHistory();

  function setStatus(t){ statusText.textContent = t; }

  function setTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem(THEME_KEY, theme);
    const isLight = theme === "light";
    themeToggle.checked = isLight;
    themeLabel.textContent = isLight ? "light" : "dark";
  }

  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    if(saved === "light" || saved === "dark"){ setTheme(saved); return; }
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    setTheme(prefersLight ? "light" : "dark");
  }

  themeToggle.addEventListener("change", () => {
    setTheme(themeToggle.checked ? "light" : "dark");
  });

  function showLogin(){
    loginView.style.display = "block";
    chatView.style.display = "none";
    logoutPill.style.display = "none";
    clearPill.style.display = "none";
  }

  function showChat(){
    loginView.style.display = "none";
    chatView.style.display = "flex";
    logoutPill.style.display = "flex";
    clearPill.style.display = "flex";
  }

  function addMessage(role, text){
    const row = document.createElement("div");
    row.className = "msg " + (role === "user" ? "me" : "bot");

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    if(role === "user"){
      avatar.textContent = "You";
    }else{
      avatar.innerHTML = `<img src="./isabelle.png" alt="Isabelle">`;
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    row.appendChild(avatar);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function saveHistory(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }
  function loadHistory(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
    catch(e){ return []; }
  }

  function renderHistory(){
    messagesEl.innerHTML = "";
    if(history.length === 0){
      const hello = "Hi, I’m Isabelle AI.\nAsk me anything about the program and I’ll answer based on the course materials you have access to.";
      addMessage("assistant", hello);
      history.push({ role:"assistant", content: hello });
      saveHistory();
      return;
    }
    for(const m of history){ addMessage(m.role, m.content); }
  }

  function autosize(){
    inputEl.style.height = "0px";
    inputEl.style.height = Math.min(160, inputEl.scrollHeight) + "px";
  }

  async function doLogin(){
    loginErr.style.display = "none";
    loginOk.style.display = "none";

    const email = (emailEl.value || "").trim();
    const password = (passwordEl.value || "").trim();

    if(!email || !password){
      loginErr.textContent = "please enter email and password";
      loginErr.style.display = "block";
      return;
    }

    setStatus("logging in...");
    loginBtn.disabled = true;

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    loginBtn.disabled = false;

    if(error){
      setStatus("ready");
      loginErr.textContent = error.message;
      loginErr.style.display = "block";
      return;
    }

    loginOk.textContent = "logged in";
    loginOk.style.display = "block";
    setStatus("ready");

    showChat();
    renderHistory();
    autosize();
    inputEl.focus();
  }

  loginBtn.addEventListener("click", doLogin);
  passwordEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){ doLogin(); }
  });

  logoutBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    await supabase.auth.signOut();
    showLogin();
  });

  clearChatEl.addEventListener("click", (e) => {
    e.preventDefault();
    history = [];
    saveHistory();
    renderHistory();
  });

  exportChatEl.addEventListener("click", (e) => {
    e.preventDefault();
    const blob = new Blob([JSON.stringify(history, null, 2)], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "isabelle-ai-chat.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  async function send(){
    const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
    const accessToken = sessionData?.session?.access_token;

    if(sessErr || !accessToken){
      addMessage("assistant", "session expired, please log in again");
      await supabase.auth.signOut();
      showLogin();
      return;
    }

    const text = inputEl.value.trim();
    if(!text) return;

    inputEl.value = "";
    autosize();

    addMessage("user", text);
    history.push({ role:"user", content:text });
    saveHistory();

    sendBtn.disabled = true;
    setStatus("thinking...");

    const payload = {
      messages: history.map(m => ({
        role: m.role,
        content: m.content
      }))
    };

    try{
      const res = await fetch(CHAT_ENDPOINT, {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "apikey": SUPABASE_ANON_KEY,
          // ✅ IMPORTANT: send the USER jwt here
          "Authorization": `Bearer ${accessToken}`
        },
        body: JSON.stringify(payload)
      });

      if(!res.ok){
        const err = await res.text();
        const msg = `server error ${res.status}\n${err}`;
        addMessage("assistant", msg);
        history.push({ role:"assistant", content: msg });
        saveHistory();
        return;
      }

      const data = await res.json();
      const reply = data?.reply || "(no reply)";
      addMessage("assistant", reply);
      history.push({ role:"assistant", content: reply });
      saveHistory();
    }catch(e){
      // this catches CORS failures + real network failures
      const msg = "network error calling the chat endpoint";
      addMessage("assistant", msg);
      history.push({ role:"assistant", content: msg });
      saveHistory();
    }finally{
      sendBtn.disabled = false;
      setStatus("ready");
    }
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("input", autosize);
  inputEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  initTheme();
  setStatus("ready");

  const { data: sessionData } = await supabase.auth.getSession();
  if(sessionData?.session){
    showChat();
    renderHistory();
    autosize();
  } else {
    showLogin();
  }
</script>
